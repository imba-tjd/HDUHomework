# 网络

* 四个主要部分：计算机，通信线路，网络互连设备，操作系统

## 分层的意义

* 各层之间是独立的
* 易于实现和维护
* 能促进标准化工作
* 若层数太少，就会使每一层协议太复杂；层数太多又会在描述和综合各层功能的系统工程任务时遇到较多的困难
* OSI模型分为7层，TCP/IP参考模型分为4层（网络接口层），TCP/IP协议栈为5层。TCP/IP在传输层上支持面向连接的协议，而OSI在网络层上。OSI先有模型，TCP/IP先有协议，模型只是对已有协议的描述。OSI定义了协议 服务 接口，TCP/IP没有

## 名词

* 应用层：应用数据（APP Data）、报文（Message）
* 传输层：TCP为段（Segment），UDP为用户数据报（Datagram）
* 网络层：包（Packet），如IP包
* 数据链路层：帧（Frame），如以太网帧
* 互联网：internet；因特网：Internet，指使用了TCP/IP的互联网；万维网：www，以HTTP和FTP协议为主的多媒体网
* 协议、服务、接口：协议是对等实体互相通信时遵守的规则。协议是水平的，服务是垂直的。下层的协议对上层用户是透明的，用户只能看到服务，服务由下至上通过层之间的接口提供
* PDU（Protocol Data Unit）协议数据单元：指对等实体之间传递的数据单位，就是上面那些各层的包
* SAP (Service Access Point) 服务接入点：二层就是MAC，三层就是IP，四层就是端口

## 应用层

* 分类有C/S和P2P两种模式，P2P通信的两者地位等同
* HTTP：无状态，1.0本身无连接。非持久的请求时间含TCP为两次RTT+传输整个文件的时间。简单快速灵活
* FTP：有状态。20端口数据连接，21端口控制连接，控制信息带外传送。有主动模式（客户端访问服务端21，服务端从20与客户端建立传输数据的链接）和被动模式（C和S的数据端口都随机）。必须登录，也有匿名的
* 邮件
  * SMTP：25端口。“用户代理”的概念
  * POP3(110端口)、IMAP(143端口)仅用于收取邮件，不能发。是“最后投递使用的协议”
  * 与HTTP的区别：一般不使用中间邮件服务器、是“推”协议而非“拉”（POP3是拉）、最初只允许报文为7位ASCII码
  * MIME(Multipurpose Internet Mail Extensions)
  * MTA(Mail Transfer Agent)其实就是邮件服务器
* DNS：使用UDP；结果大于512字节时自动要求客户端用TCP；服务器区域传输时也用TCP。记录以(Name,Value,Type,TTL)组成。递归查询、迭代查询
* P2P：最小分发时间
* Telnet：23端口
* DHCP：使用UDP
* Web服务器缓解转发端的压力，使用：TCP移交。不选代理服务器或负载均衡

## 传输层

* 使用传输层把数据从应用层发往网络层叫多路复用，反之叫多路分解
* TCP连接不是虚电路，中间的网络元素不会维持TCP连接状态
* TCP首部结构：2字节源端口号0~65535，2字节目的端口号，4字节序号，4字节确认号。4bit首部长度/数据偏移，以4字节为单位。典型首部长度为20字节。无总长度。URG=1和紧急指针：表明从数据开始到紧急指针之间为紧急数据，即使接收方窗口为0也能发送
* UDP首部结构：一共8字节，2字节源端口，2字节目的端口，2字节长度（包括首部长度在内），2字节校验和
* 最大传输单元MTU一般为1500字节，而TCP与IP头分别为20字节，所以最大报文段长度MSS一般为1460字节
* TCP三步握手
* 自下而上首次提供端到端的通信（不是点到点）

### 可信传输

* 无差错、不丢失、不重复、按序到达
* 可信信道RDT1.0 -> 有差错的信道RDT2.0（校验和、NAK） -> 包会丢失的信道RDT3.0（定时器，超时策略，停等协议） -> 流水线（序号Seq，回退N步GBN/自动重传请求ARQ、选择重传SR）
* 停等协议必须等收到ACK才能发下一个包
* GBN接收端会直接丢弃失序分组，ACK编号为最后收到的有序分组号，发送端超时后会重传所有未确认的分组
* SR接收端收到哪个分组号就ACK哪个，不是最后有序的，发送端对于没有ACK的分组仅超时重传那一个
* TCP是两者的综合
  * ACK编号为最后收到的有序分组号+1，发送端仅重传那一个
  * 累计ACK：发送端收到失序ACK时不会立即重传，如果之后又收到了值更大的ACK则说明接收端已经正确收到了那个包
  * 快速重传：发送端连续收到3次相同编号的ACK就立即重传那个
* SR的窗口长度必须小于等于序号空间大小的一半
* 利用率：实际推数据的时间（nL/R）/ 总时间（RTT+L/R），其中停等协议的n为1，分母一直不带n

### 拥塞控制

* 流量控制：接收端TCP首部“接收窗口”rwnd表示缓冲区剩余大小、拥塞窗口：cwnd。发送端的发送窗口：两者中的较小值
* 慢启动：cwnd以1MSS开始，每过一个时间段就翻倍（或称为每次ACK就+1）
* 拥塞避免：cwnd达到“慢启动阈值”ssthresh（默认16）后，每过一个时间段+1
* 发生超时后，把ssthresh设为当前cwnd的一半，再把cwnd设为1，进入慢启动
* 快速恢复(TCP Reno)：收到三个冗余ACK后，把ssthresh和cwnd都设为当前cwnd的一半（另一种做法是cwnd设为一半+3），继续拥塞避免
* 区别：拥塞控制是全局性的过程，流量控制是个端到端的问题。相同之处：都是限制发送方的速率

### TCP和UDP的区别

* TCP要建立连接，有时延
* TCP有流量控制，拥塞控制的功能
* UDP不保证可靠交付
* UDP首部开销更小
* TCP只支持点对点(一对一)，UDP支持一对多、多对一、多对多

## 网络层

* 异构网络互联
* 路由器的功能：分组转发和路由选择
* ICMP网际控制报文协议、ARP地址解析协议
* 子网：节约IP资源、隔离广播减少网络流量。主机位全0和全1不能用
  * CIDR 无类别域间路由。
  * 超网、路由聚合：缩减了路由表的规模、隔离路由翻动
* NAT 网络地址转换
  * 违背了IP结构模型——每个IP地址唯一标识一台机器
  * 将互联网变成了“面向连接”的网络，NAT转换器维护了状态，增加了延时减少了性能
  * 违背了协议分层原则
  * 优点：节约IP、有一定的安全性

### IP首部

* 4bit版本号
* 4bit首部长度，以4字节为单位。最小0101=5✖4=20字节，最大1111=15✖4=60字节
* 2字节总长度，包括首部长度在内
* 紧急指针：即使rwnd为0也可以发送
* 片偏移和分片
  * 13bit，以8字节为单位
  * 分片时MF为1，最后一片MF为0；DF必须一直为0
  * 第一片的偏移为0，第二片的值为第一片的数据长度/8
* TTL：避免分组无限转发
* IPV6
  * 分为基本头部、扩展头部、载荷，“下一个头”指示了三者间的关系
  * 基本首部固定长度40字节
  * 去掉了校验和、分片
  * 组播：FF00::/8。链路本地：FE80::/10，后64位根据48位MAC地址生成EUI64地址。局域网本地：FEC0::/10。没有广播地址，组播代替了

### 虚电路

* ATM、帧中继、MPLS（一种介于23层之间的硬件交换分组的技术）
* 由网络层确保交付
* 保证有序，具有时延上界
* 需要建立连接，中间的路由器必须为连接维持状态信息
* 链路具有VC虚电路号，不同链路的VC号不同
* 属于同一虚电路的分组均按同一路由转发
* 端到端的差错处理和流量控制可以由网络负责，也可以由用户主机负责
* 某一结点出故障会导致通过它的所有虚电路都无法使用
* 因特网不使用虚电路，而是用数据报。数据报中每个分组都有都有完整的目的地址；仅使用目标IP进行路由，无需为每一条连接单独维护转发表；而虚电路仅在建立连接阶段使用目的地址，之后每个分组使用长度较短的虚电路号

### 路由选择算法

* RIP路由信息协议
  * 使用距离向量(DV)算法，仅和邻居交换信息，但提供自己所知的所有距离信息（路由表）
  * 当一条链路的费用发生变化时，仅当信息导致直连链路费用变化了才传播变化了的费用
  * 有“路由选择环路”和“无穷计数”问题，适用于小型网络
  * 好消息传得快，坏消息传得慢（慢收敛）：当网络出现故障时，需要较长时间才能将消息传送给所有的路由器
  * 一个不正确的结点计算值会扩散到整个网络
  * 使用UDP协议
* OSPF开放最短路径优先
  * 使用链路状态(LS)算法，基本就是Dijkstra算法
  * 每个结点经广播与所有其它结点交谈，但仅告诉它们与其直连链路的费用
  * 当一条链路的费用发生变化时，必须将该新的链路费用发向所有结点
  * 复杂度O(n^2)，产生O(ne)个报文
  * 更健壮
  * 使用IP协议
* “总之，两个算法没有一个是明显的赢家，它们都在因特网中得到了应用”
* BGP边界网关协议：AS之间的路由选择，非最优路由，使用TCP协议，端口179
* 避免路由环路：水平分割、毒性逆转

### 不同网段的通信

1. 判断是不同网段的
2. 查找路由表
3. 发现网关MAC
4. ip包发给网关
5. 网关接收以太网帧
6. 网关路由转发
7. 每经过一个路由器，源IP和目的IP不变，会改变MAC地址

## 数据链路层

* 组帧/封装成帧：加首部和尾部
  * 透明传输：如果数据里存在首部的标识(帧边界)，需要进行处理
  * 字符计数法：在帧首部添加长度计数字段。容错性差
  * 字符(字节)填充法：在帧周围加某FLAG字符表示边界。如果数据里存在FLAG，则再再其前面加某ESC字符表示转义；若数据里也有ESC则也加ESC。可类比于`"\""`
  * 零比特(位)填充法：如用01111110表示帧边界，数据里出现连续5个1时，自动在后面加一个0，接收者遇到5个1时去掉0。效率更高，支持非整数倍字节数据
  * 违规编码法：曼彻斯特编码中没有使用高-高和低-低表示数据，那就用它们表示帧边界
  * PPP协议异步时使用字节填充，同步时使用比特填充
* 差错控制
  * 奇偶校验码：加上1bit校验位后有奇/偶个1。两者都只能检测出奇数个错误
  * CRC：生成多项式：假如为x^5+x^4+x+1，则对应110011作为除数。对于k位的数据，已知一个n位的除数，在原数据后加n-1个零，除以除数，余的n-1位拼到原数据后。接收者将收到的数据除以除数，余0证明无错
  * 纠错编码：海明码。设n为有效信息的位数，k为校验位的个数，则需满足n+k<=2^k-1。海明距：纠错d位需2d+1的编码方案，检错只需d+1
  * 以太网只进行差错检测，不纠正
* 本层也有流量控制，但为点对点的，窗口大小在传输过程中不会变
* MAC介质访问控制
  * 信道划分介质访问控制（静态）：负载较重时效率高、公平
    * FDM有保护带，OFDM(正交)无保护带，用于802.11
    * TDM蜂窝网络中用到
    * CDMA码分复用，3G中用到。不同发送者具有互相正交的码片，发送1就发送它，发送0就取反。接收者对数据用某一发送者的码片每bit相乘求和再除以长度，如果结果不是1或-1则表示不是那个用户的消息
    * WDM波分复用，光纤中用到
  * 轮询：单点故障、等待延迟、轮询开销；独占带宽、不冲突
  * 随机：见下
* 一般的交换机和网桥使用**存储转发传输机制**，传输分组前必须接收整个分组；可靠性高，支持不同速率的端口之间交换；隔离冲突域，不隔离广播域。也有直通转发模式
* 局域网
  * 范围小，速度快，延迟低，误码率低可靠性高
  * 常用总线型拓扑
 * 广域网：结点之间通常是点到点连接。PPP不可靠、HDLC高级数据链路控制可靠
* LLC和MAC：IEEE802将本层划分为 逻辑链路控制层LLC和媒体接入控制MAC，MAC用于透明传输，LLC用于面向连接。但以太网不用LLC，现在的网卡一般也没有

### 随机访问介质访问控制

* 所有用户都可以随机发送信息，发送时可以占用全部带宽；信道空闲时的利用率比静态划分效率更高；可能发生冲突
* ALOHA：想法就发，一定时间没收到确认就随机等一段时间重发
* 时隙ALOHA：只能在一个时间片的开始时发
* CSMA载波监听多路访问
  * 发送前监听信道（先听后发）
  * 1-坚持：如果空闲，立即发送。如果忙，坚持监听，一旦空闲就立即发送
  * 非坚持：如果空闲，立即发送。如果忙，放弃监听，随机等一段时间再监听
  * p-坚持：如果空闲，以p的概率发送，1-p的概率推迟到下一个时间片。如果忙，等下一个时间片再监听
  * CSMA/CD
    * 边发边听，冲突停发（普通CSMA发生冲突了不管，只看没有确认就才重发，之前的就白发了）
    * 只能进行半双工通信
    * 使用二进制指数退避算法（延迟重发）：对于第i次重试，在[0,2^i-1]里随机选一个数，乘以争用期。最大2^10-1；第16次失败则放弃
    * 争用期/冲突窗口：端到端传播时延的两倍。最小帧长：争用期*传输速率。如果超过此长度还没有发生冲突，那后序数据就也不会冲突（表示已经成功抢占信道）。收到小于最小帧长的要丢弃，表示发生了冲突。发送方的数据小于最小帧长时要填充
  * CSMA/CA：用于无线局域网。要实现碰撞检测，硬件花费就会过大；还有隐蔽站的问题。使用了预约信道（RTS和CTS帧）和ACK帧。发送包时无法检测信道有没有冲突

## 物理层

* 定义机械特性（接口形状、引脚数量）、电气特性（电压范围）、功能特性（某一电平表示何种意义）、过程特性（时序，类似于协议），提供比特流的透明传输。传输介质属于第零层
* 中继器Repeater：再生数字信号。集线器Hub：多端口的中继器。不是存储转发设备。收发器Transceiver：之前是外设，现在集成在网卡里了，也叫MAU(Media Attachment Unit)，能将一种信号转换为另一种
* 串行传输：速度慢，费用低，适合远距离，有衰减问题。并行传输：速度快，费用高，适合近距离传输，有串扰问题
* 同轴电缆抗干扰特性比普通双绞线好，但价格更贵
* 单模光纤适合远距离传输，价格贵；多模相反。都不受电磁干扰
* 电路交换（需建立连接，时延小、有序、无冲突、控制简单、灵活性差、利用率低线路独占、支持模拟信号）、报文交换（存在转发时延）、分组交换（包交换）。分组交换又分为数据报和虚电路，由网络层提供

### 编码（调制技术）

* NRZ不归零：高电平表示1，低电平表示0
* NRZI不归零逆转：在比特时间内，电压跳变了则表示1，没跳变表示0。解决了连续1问题，但仍存在连续0问题。也有别的说法。USB中采用
* 曼彻斯特编码：一个比特时间内，从高跳到低则表示1，低到高表示0。标准以太网使用，效率只有50%
* 差分曼彻斯特编码：一个比特时间开始时，跳变表示0，不跳表示1。每个比特时间中部还会跳变，但仅用于时钟同步
* 4B/5B编码：快速以太网使用
* 码元传输速率/码率/波特率/采样率/调制速率：发送高低电平的频率。比特率：数据速率。比特率=码率*log2(每个信号单元对应几位比特)。标准以太网的数据速率是10Mb/s，波特率是数据率的两倍，即20M波特
* 奈奎斯特定理：无噪音信道的极限码率=2Wlog2(V)。W是信道带宽Hz，V是码元数目，如=相位数*振幅数
* 香农公式：有噪声信道：W×log2(1+S/N)（bps）。其中S/N是信噪比，一般是一个量；如果题目给的是分贝(dB)=10log10(S/N)要解出S/N

### 分组交换

* 传输时延(发送时延)：将分组推向链路所需的时间。NL/R，N为路由器数量加一或链路数，L是比特数，R是传输速率且是所有链路中速度最小的哪个（瓶颈链路）
* 传播时延：介质中的速度/距离
* 处理时延：检查差错，同步卫星的很大
* 排队时延：等待传输，如果是空的则为0，用流量强度衡量：La/R，L是每组比特数（每个请求的网速），a是每秒到达的分组数（每秒请求数），R是传输速率（带宽大小）；不能大于1，否则丢包
* 传输效率=吞吐量/带宽
* 时延带宽积=传播时延*带宽，单位是bit。是链路中能通过的最多数据量
* 计算
  1. 已知用户数据的长度为x比特，每个分组的数据部分长度为p比特，则需要的分组总数是x/p。已知每个分组的报头长度为h比特，则需要传送的分组总长度为(p+h)x/p比特
  2. 已知链路速率是b，源端发送所需时间是(p+h)x/(pb)，中间经过k个路由器转发，每次转发需要的时间为(p+h)/b，因此用户数据总的传输时延为(p+h)x/(pb) + k(p+h)/b
  * 电路交换的传输时延：总长度/b

## 名词

* ADSL Asymmetric Digital Subscriber Line 非对称数字用户线路
* ATM Asynchronous Transfer Mode 异步传输模式
* FDDI Fiber Distributed Data Interface 光纤分布式数据接口
* FTTH Fiber to the home 光纤入户
* ISP Internet Service Provider 互联网服务提供商
* IXP Internet Exchange Point 互联网交换中心
* MPLS Multi-Protocol Label Switching 多协议标签交换
* PSTN Public Switched Telephone Network 公共交换电话网络
* UTP Unshielded Twisted Paired 非屏蔽双绞线

## 参考

* https://www.bilibili.com/video/BV19E411D78Q
* https://blog.csdn.net/weixin_45067603/category_10139126.html

### 练习

* https://edu.csdn.net/skill/network
